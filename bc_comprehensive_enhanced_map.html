<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BC Marine Conservation - Enhanced Comprehensive Analysis Map</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background-color: #f0f8ff;
        }

        .header {
            background-color: #1a472a;
            color: white;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            margin: 0;
            font-size: 1.8em;
        }

        .header p {
            margin: 5px 0 0 0;
            font-size: 1em;
            opacity: 0.9;
        }

        .container {
            display: flex;
            height: calc(100vh - 80px);
        }

        .sidebar {
            width: 350px;
            background-color: white;
            padding: 20px;
            overflow-y: auto;
            border-right: 2px solid #1a472a;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        }

        .layer-section {
            margin-bottom: 25px;
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
        }

        .layer-header {
            background-color: #1a472a;
            color: white;
            padding: 12px 15px;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .layer-content {
            padding: 15px;
            background-color: #f9f9f9;
        }

        .layer-toggle {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .layer-toggle input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .layer-toggle label {
            font-weight: bold;
            color: #1a472a;
            cursor: pointer;
            flex: 1;
        }

        #map {
            flex: 1;
            height: 100%;
        }

        .zone-popup {
            max-width: 600px;
            max-height: 500px;
            overflow-y: auto;
        }

        .zone-popup h4 {
            margin: 0 0 10px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #1a472a;
        }

        .zone-popup .section {
            margin-bottom: 15px;
        }

        .zone-popup .section h5 {
            margin: 0 0 5px 0;
            color: #1a472a;
            font-size: 14px;
        }

        .zone-popup .industrial-ops {
            background-color: #fff3cd;
            padding: 8px;
            border-radius: 4px;
            border-left: 4px solid #ffc107;
            margin-bottom: 10px;
        }

        .zone-popup .conservation-obj {
            background-color: #d1ecf1;
            padding: 8px;
            border-radius: 4px;
            border-left: 4px solid #17a2b8;
            margin-bottom: 10px;
        }

        .zone-popup .cultural-obj {
            background-color: #d4edda;
            padding: 8px;
            border-radius: 4px;
            border-left: 4px solid #28a745;
            margin-bottom: 10px;
        }

        .zone-popup img {
            max-width: 300px;
            width: 100%;
            height: auto;
            margin: 10px 0;
            border-radius: 4px;
            display: block;
        }

        .zone-popup-container .leaflet-popup-content {
            margin: 10px 15px;
            line-height: 1.4;
            font-size: 13px;
        }

        .zone-popup-container .leaflet-popup-content-wrapper {
            background: white;
            color: #333;
            border-radius: 8px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
        }

        .zone-popup ul {
            margin: 8px 0;
            padding-left: 18px;
        }

        .zone-popup li {
            margin: 4px 0;
            line-height: 1.3;
            font-size: 12px;
        }

        .zone-popup h5 {
            margin: 12px 0 6px 0 !important;
            font-size: 13px !important;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>BC Marine Conservation - Enhanced Comprehensive Analysis</h1>
        <p>Interactive map with detailed MCP zone information, marine operations, shipping routes, and fishing areas</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="layer-section">
                <div class="layer-header">
                    üèõÔ∏è MCP Zones (Category 1)
                </div>
                <div class="layer-content">
                    <div class="layer-toggle">
                        <input type="checkbox" id="zones-100-103" checked>
                        <label for="zones-100-103">Zones 100-103: Penrose, Rivers Inlet</label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="zones-110-114" checked>
                        <label for="zones-110-114">Zones 110-114: Hakai Pass</label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="zones-130-138" checked>
                        <label for="zones-130-138">Zones 130-138: Burke, Bentick</label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="zones-140-146" checked>
                        <label for="zones-140-146">Zones 140-146: Dean Channel</label>
                    </div>
                </div>
            </div>

            <div class="layer-section">
                <div class="layer-header">
                    üè≠ Marine Operations
                </div>
                <div class="layer-content">
                    <div class="layer-toggle">
                        <input type="checkbox" id="lng-facilities" checked>
                        <label for="lng-facilities">LNG Facilities</label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="ports" checked>
                        <label for="ports">Ports & Terminals</label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="aquaculture" checked>
                        <label for="aquaculture">Aquaculture Sites</label>
                    </div>
                </div>
            </div>

            <div class="layer-section">
                <div class="layer-header">
                    üö¢ Shipping Routes
                </div>
                <div class="layer-content">
                    <div class="layer-toggle">
                        <input type="checkbox" id="lng-routes" checked>
                        <label for="lng-routes">LNG Export Routes</label>
                    </div>
                    <div class="layer-toggle">
                        <input type="checkbox" id="inside-passage" checked>
                        <label for="inside-passage">Inside Passage</label>
                    </div>
                </div>
            </div>
        </div>

        <div id="map"></div>
    </div>

    <!-- Leaflet JavaScript -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // Initialize map centered on Central Coast BC
        const map = L.map('map').setView([52.5, -128.0], 8);

        // Add OpenStreetMap tiles
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(map);

        // Color scheme for different zone groups
        const zoneColors = {
            '100-103': '#FF6B6B',
            '110-114': '#4ECDC4',
            '130-138': '#45B7D1',
            '140-146': '#F7DC6F'
        };

        // Layer groups for organizing markers
        const mcpZoneGroups = {};
        const operationTypes = {
            'LNG': L.layerGroup(),
            'Port': L.layerGroup(),
            'Aquaculture': L.layerGroup(),
            'Fishing': L.layerGroup(),
            'MPA': L.layerGroup(),
            'Anchorage': L.layerGroup()
        };
        const routeLayers = {};

        // Simplified but complete MCP Zone Data - all zones included
        const allZoneData = {
            '100-103': {
                name: "Penrose, Rivers Inlet, and Calvert South Group",
                overview: "Focuses on rich ecological and cultural values within the Penrose, Rivers Inlet, and Calvert South areas.",
                mapImage: "https://raw.githubusercontent.com/M0nkeyFl0wer/MPA/main/central_coast_images/central_coast_page_167_img_1.png",
                zones: [
                    {id: 100, name: 'Zone 100 - Penrose Island', coords: [52.3, -128.2], hasDetailed: true},
                    {id: 101, name: 'Zone 101 - Rivers Inlet', coords: [52.35, -128.25], hasDetailed: false},
                    {id: 102, name: 'Zone 102 - Calvert South', coords: [52.25, -128.15], hasDetailed: true},
                    {id: 103, name: 'Zone 103 - Calvert Estuary', coords: [52.28, -128.18], hasDetailed: true}
                ]
            },
            '110-114': {
                name: "Hakai Pass Group",
                overview: "Targets the ecologically and culturally rich Hakai Pass area, known for its diverse habitats and species.",
                mapImage: "https://raw.githubusercontent.com/M0nkeyFl0wer/MPA/main/central_coast_images/central_coast_page_173_img_1.png",
                zones: [
                    {id: 110, name: 'Zone 110 - Hakai Pass North', coords: [52.4, -128.3], hasDetailed: true},
                    {id: 111, name: 'Zone 111 - Hakai Pass Central', coords: [52.38, -128.28], hasDetailed: true},
                    {id: 112, name: 'Zone 112 - Hakai Pass South', coords: [52.36, -128.26], hasDetailed: true},
                    {id: 113, name: 'Zone 113 - Hakai Outer', coords: [52.42, -128.32], hasDetailed: true},
                    {id: 114, name: 'Zone 114 - Hakai Inner', coords: [52.34, -128.24], hasDetailed: true}
                ]
            },
            '130-138': {
                name: "Burke, Codville Lagoon, and Bentick Arm Groups",
                overview: "These zones include areas with significant estuarine and kelp habitats, important for various salmon species, marine mammals, and for First Nations food security.",
                mapImage: "https://raw.githubusercontent.com/M0nkeyFl0wer/MPA/main/central_coast_images/central_coast_page_181_img_1.png",
                zones: [
                    {id: 130, name: 'Zone 130 - Burke Channel', coords: [52.5, -127.8], hasDetailed: true},
                    {id: 131, name: 'Zone 131 - Codville Lagoon', coords: [52.52, -127.82], hasDetailed: true},
                    {id: 132, name: 'Zone 132 - Bentick Arm North', coords: [52.48, -127.78], hasDetailed: true},
                    {id: 133, name: 'Zone 133 - Bentick Arm South', coords: [52.46, -127.76], hasDetailed: false},
                    {id: 134, name: 'Zone 134 - Bentick Outer', coords: [52.44, -127.74], hasDetailed: false},
                    {id: 136, name: 'Zone 136 - Burke Outer', coords: [52.54, -127.84], hasDetailed: false},
                    {id: 137, name: 'Zone 137 - Burke Inner', coords: [52.56, -127.86], hasDetailed: false},
                    {id: 138, name: 'Zone 138 - Codville Inner', coords: [52.58, -127.88], hasDetailed: false}
                ]
            },
            '140-146': {
                name: "Dean Channel and Cascade Inlet Group",
                overview: "Important areas for salmon spawning, marine bird nesting, and First Nations cultural practices.",
                mapImage: null,
                zones: [
                    {id: 140, name: 'Zone 140 - Dean Channel', coords: [52.6, -127.5], hasDetailed: false},
                    {id: 141, name: 'Zone 141 - Cascade Inlet', coords: [52.62, -127.52], hasDetailed: false},
                    {id: 142, name: 'Zone 142 - Labouchere Channel', coords: [52.58, -127.48], hasDetailed: false},
                    {id: 143, name: 'Zone 143 - Kimsquit Bay', coords: [52.64, -127.54], hasDetailed: false},
                    {id: 144, name: 'Zone 144 - Dean Outer', coords: [52.56, -127.46], hasDetailed: false},
                    {id: 145, name: 'Zone 145 - Cascade Outer', coords: [52.66, -127.56], hasDetailed: false},
                    {id: 146, name: 'Zone 146 - Kimsquit Outer', coords: [52.68, -127.58], hasDetailed: false}
                ]
            }
        };

        // First Nations territory data for zones
        const firstNationsData = {
            '100-103': {
                primaryNations: ['Wuikinuxv Nation', 'Heiltsuk Nation', 'Nuxalk Nation'],
                territorialNotes: 'Traditional territory overlap - Rivers Inlet (Wuikinuxv), Central Coast (Heiltsuk)',
                partnerships: 'Great Bear Sea MPA Partnership members'
            },
            '110-114': {
                primaryNations: ['Heiltsuk Nation', 'Nuxalk Nation'],
                territorialNotes: 'Traditional harvesting areas and cultural sites',
                partnerships: 'Great Bear Sea MPA Partnership'
            },
            '130-138': {
                primaryNations: ['Nuxalk Nation', 'Heiltsuk Nation'],
                territorialNotes: 'Nuxalk primary territory (Burke Channel), Traditional estuarine and kelp habitats',
                partnerships: 'Great Bear Sea MPA Partnership'
            },
            '140-146': {
                primaryNations: ['Nuxalk Nation'],
                territorialNotes: 'Nuxalk traditional territory - Dean Channel, Cascade Inlet areas',
                partnerships: 'Great Bear Sea MPA Partnership'
            }
        };

        // Enhanced detailed conservation data with bullet point summaries
        const detailedZoneInfo = {
            100: {
                habitat: ["Eelgrass meadows", "Kelp beds", "Estuaries"],
                keySpecies: ["Multiple salmon species", "Geoduck, abalone, crab, prawn", "Groundfish", "Marine birds"],
                ecological: ["Unique clam harvest site", "Herring spawn area", "High rockfish diversity", "Abalone restoration site"],
                cultural: ["Traditional shellfish harvesting", "Salmon rearing areas"],
                risks: ["Aquaculture impacts"],
                industrial: ["Mowi Canada West - Kid Bay", "Mowi Canada West - Goat Cove"]
            },
            102: {
                habitat: ["Eelgrass meadows", "Kelp beds", "Estuaries"],
                keySpecies: ["Steelhead", "All salmon species", "Dungeness crab", "Spot prawn", "Rockfish"],
                ecological: ["Salmon diversity hotspot", "Representative marine habitats", "Rare species protection"],
                cultural: ["Seasonal camps", "Weather access routes", "Spiritual sites", "Teaching areas"],
                risks: ["Fishing interactions with eulachon"],
                industrial: []
            },
            103: {
                habitat: ["Eelgrass meadows", "Estuaries"],
                keySpecies: ["Chinook, Coho, Pink, Sockeye salmon", "Dungeness crab", "Spot prawns", "Giant Pacific octopus"],
                ecological: ["Salmon diversity hotspot", "Shellfish beds"],
                cultural: ["Traditional harvesting areas"],
                risks: ["Beach seine conflicts with eulachon"],
                industrial: []
            },
            110: {
                habitat: ["Estuaries", "Eelgrass", "Bull kelp", "Giant kelp"],
                keySpecies: ["Steelhead", "Sockeye salmon", "Lingcod", "China, Quillback, Tiger, Yelloweye rockfish", "Boot and cloud sponges"],
                ecological: ["Abalone larval site", "Diverse rockfish habitat", "Sponge reefs"],
                cultural: ["Seasonal camps", "Food security species", "Teaching areas"],
                risks: ["Habitat degradation"],
                industrial: []
            },
            111: {
                habitat: ["Sandy bottom", "Eelgrass", "Bull kelp", "Cloud sponge reefs"],
                keySpecies: ["Bocaccio, Canary rockfish", "Steelhead", "Lingcod", "Gorgonians", "Northern abalone"],
                ecological: ["Highest rockfish diversity", "Early sockeye habitat", "Herring spawn", "Complex habitats"],
                cultural: ["Seasonal camps", "Cultural sites", "Diverse food species"],
                risks: ["Overfishing of rockfish"],
                industrial: []
            },
            112: {
                habitat: ["Representative marine habitats", "Nearshore sponge reefs"],
                keySpecies: ["Quillback, Yelloweye rockfish", "Olympia oyster", "Boot, Cloud, Glass sponges"],
                ecological: ["Halibut breeding", "Very high rockfish diversity", "Unique sponge communities"],
                cultural: ["First Nations stewardship showcase", "Cultural sites"],
                risks: ["Fishing pressure on threatened rockfish"],
                industrial: []
            },
            113: {
                habitat: ["Eelgrass beds", "Boot and cloud sponge areas"],
                keySpecies: ["Quillback rockfish", "Northern abalone"],
                ecological: ["Rare species protection", "Abalone habitat"],
                cultural: ["Traditional harvesting"],
                risks: ["Abalone population recovery"],
                industrial: []
            },
            114: {
                habitat: ["Estuaries", "Marine bird nesting areas"],
                keySpecies: ["All salmon species", "Marine birds"],
                ecological: ["Pacific salmon biomass hotspot", "Salmon diversity hotspot", "Bird nesting"],
                cultural: ["Seasonal camps", "Food security species", "Teaching areas"],
                risks: ["Development pressure"],
                industrial: []
            },
            130: {
                habitat: ["Eelgrass meadows", "Kelp beds", "Estuaries"],
                keySpecies: ["Juvenile salmon (Chum, Coho, Pink, Sockeye)", "Yelloweye rockfish", "Dungeness crab", "Giant Pacific octopus"],
                ecological: ["Salmon nursery", "Diverse invertebrate community"],
                cultural: ["Traditional harvesting areas"],
                risks: ["Logging operations affecting nearshore"],
                industrial: ["Tweedsmuir Park Lodge access", "Chris Carlson Guide Service"]
            },
            131: {
                habitat: ["Kelp beds", "Eelgrass", "High current areas"],
                keySpecies: ["Northern Resident Killer Whales", "Humpback whales", "Sea ducks", "Yelloweye rockfish"],
                ecological: ["Whale habitat", "Sea duck moulting", "High current ecosystems"],
                cultural: ["Seasonal camps", "Food security species"],
                risks: ["Vessel traffic", "Marine mammal disturbance"],
                industrial: []
            },
            132: {
                habitat: ["Large estuaries", "Salmon streams"],
                keySpecies: ["Chum, coho, pink salmon", "Eulachon", "Marbled murrelet", "Dungeness crab"],
                ecological: ["Salmon diversity hotspots", "Eulachon spawning", "Threatened species habitat"],
                cultural: ["Herring spawn harvest", "Unique eulachon site"],
                risks: ["Beach seine interactions with eulachon"],
                industrial: []
            },
            133: {
                habitat: ["Estuaries", "Eelgrass meadows", "Kelp beds"],
                keySpecies: ["All salmon species", "Quillback, Silvergray rockfish", "Eulachon", "Lingcod"],
                ecological: ["Salmon diversity", "Estuary habitat", "Unique rockfish populations"],
                cultural: ["Migratory bird harvesting", "Unique eulachon site"],
                risks: ["Seine net conflicts with eulachon"],
                industrial: []
            },
            140: {
                habitat: ["Estuarine fjord", "Benthic fish habitat"],
                keySpecies: ["Quillback rockfish", "Pacific halibut", "Spot prawn", "Northern Resident Killer Whales"],
                ecological: ["Fjord ecosystems", "Sea duck staging", "Deep water habitat"],
                cultural: ["Traditional fishing grounds"],
                risks: ["Deep water trawling"],
                industrial: ["Chris Carlson Guide Service - Dean Channel operations"]
            },
            141: {
                habitat: ["Cultural marine areas", "Traditional village sites"],
                keySpecies: ["Marine mammals", "Groundfish", "Salmon"],
                ecological: ["Diverse marine life"],
                cultural: ["Past permanent village", "Seasonal sites", "Spiritual areas"],
                risks: ["Cultural site disturbance"],
                industrial: []
            },
            142: {
                habitat: ["Kelp beds", "Rock cliffs", "High current areas"],
                keySpecies: ["Eulachon", "Pacific herring", "Pacific halibut", "Northern Resident Killer Whales"],
                ecological: ["Herring spawn", "Halibut rearing", "High current ecosystems"],
                cultural: ["Traditional camps", "Teaching areas"],
                risks: ["Current changes", "Climate impacts"],
                industrial: []
            },
            143: {
                habitat: ["Benthic fish areas", "Marine bird habitat"],
                keySpecies: ["Yelloweye rockfish", "Spot prawn", "Northern Resident Killer Whales", "Geese/swans"],
                ecological: ["Rockfish diversity", "Marine bird staging", "Whale habitat"],
                cultural: ["Indian Reserve area", "High diversity harvesting", "Teaching areas"],
                risks: ["Fishing pressure", "Whale disturbance"],
                industrial: []
            },
            144: {
                habitat: ["Estuaries", "Eelgrass meadows"],
                keySpecies: ["Dungeness crab", "Pacific halibut", "Redstripe rockfish"],
                ecological: ["Crab nursery", "Halibut rearing", "Unique rockfish"],
                cultural: ["Traditional camps", "Food security species"],
                risks: ["Habitat modification"],
                industrial: []
            },
            145: {
                habitat: ["Estuaries", "Eelgrass meadows"],
                keySpecies: ["Eulachon", "Marbled murrelet", "Chum salmon"],
                ecological: ["Eulachon spawning", "Saltwater shore spawning", "Threatened species"],
                cultural: ["Traditional spawning sites"],
                risks: ["Seine net conflicts with eulachon"],
                industrial: []
            },
            146: {
                habitat: ["Estuaries", "Salmon streams"],
                keySpecies: ["Steelhead", "All salmon species", "Eulachon", "Marbled murrelet"],
                ecological: ["Pacific salmon biomass hotspot", "Saltwater chum spawning", "Herring spawn"],
                cultural: ["High harvest diversity", "Unique spawning sites"],
                risks: ["Multiple fishing conflicts with eulachon"],
                industrial: []
            }
        };

        // Initialize MCP Zones
        function initMCPZones() {
            Object.keys(allZoneData).forEach(groupKey => {
                const group = L.layerGroup();
                mcpZoneGroups[groupKey] = group;
                const groupData = allZoneData[groupKey];

                groupData.zones.forEach(zone => {
                    const marker = L.circleMarker(zone.coords, {
                        color: zoneColors[groupKey],
                        fillColor: zoneColors[groupKey],
                        fillOpacity: 0.7,
                        radius: 10,
                        weight: 3
                    });

                    // Create popup content with enhanced bullet point format
                    let popupContent = `
                        <div class="zone-popup">
                            <h4 style="color: ${zoneColors[groupKey]};">${zone.name}</h4>

                            <div class="section">
                                <p><strong>MCP Zone Group:</strong> ${groupKey}</p>
                                <p><strong>Coordinates:</strong> ${zone.coords[0].toFixed(4)}¬∞N, ${Math.abs(zone.coords[1]).toFixed(4)}¬∞W</p>
                                <p><strong>Status:</strong> Category 1 - Implementation by 2025</p>
                            </div>

                            <div class="section">
                                <h5>Group: ${groupData.name}</h5>
                                <p><em>${groupData.overview}</em></p>
                            </div>
                    `;

                    // Add detailed information if available
                    const detailed = detailedZoneInfo[zone.id];
                    if (detailed) {
                        // Habitat Information
                        if (detailed.habitat && detailed.habitat.length > 0) {
                            popupContent += `
                                <div class="conservation-obj">
                                    <h5>üåä Primary Habitats</h5>
                                    <ul>${detailed.habitat.map(h => `<li>${h}</li>`).join('')}</ul>
                                </div>
                            `;
                        }

                        // Key Species
                        if (detailed.keySpecies && detailed.keySpecies.length > 0) {
                            popupContent += `
                                <div class="conservation-obj">
                                    <h5>üêü Key Species</h5>
                                    <ul>${detailed.keySpecies.map(s => `<li>${s}</li>`).join('')}</ul>
                                </div>
                            `;
                        }

                        // Ecological Highlights
                        if (detailed.ecological && detailed.ecological.length > 0) {
                            popupContent += `
                                <div class="conservation-obj">
                                    <h5>üåø Ecological Highlights</h5>
                                    <ul>${detailed.ecological.map(e => `<li>${e}</li>`).join('')}</ul>
                                </div>
                            `;
                        }

                        // Cultural Significance
                        if (detailed.cultural && detailed.cultural.length > 0) {
                            popupContent += `
                                <div class="cultural-obj">
                                    <h5>üèõÔ∏è Cultural Significance</h5>
                                    <ul>${detailed.cultural.map(c => `<li>${c}</li>`).join('')}</ul>
                                </div>
                            `;
                        }

                        // Risk Factors
                        if (detailed.risks && detailed.risks.length > 0) {
                            popupContent += `
                                <div class="industrial-ops">
                                    <h5>‚ö†Ô∏è Risk Factors</h5>
                                    <ul>${detailed.risks.map(r => `<li>${r}</li>`).join('')}</ul>
                                </div>
                            `;
                        }

                        // Industrial Operations
                        if (detailed.industrial && detailed.industrial.length > 0) {
                            popupContent += `
                                <div class="industrial-ops">
                                    <h5>üè≠ Industrial Operations</h5>
                                    <ul>${detailed.industrial.map(op => `<li>${op}</li>`).join('')}</ul>
                                </div>
                            `;
                        }
                    } else {
                        popupContent += `
                            <div class="section">
                                <p><em>Detailed conservation objectives available in comprehensive documentation.</em></p>
                            </div>
                        `;
                    }

                    // Add First Nations territory information
                    const fnData = firstNationsData[groupKey];
                    if (fnData) {
                        popupContent += `
                            <div class="cultural-obj">
                                <h5>üèõÔ∏è First Nations Territory</h5>
                                <p><strong>Primary Nations:</strong> ${fnData.primaryNations.join(', ')}</p>
                                <p><strong>Territorial Context:</strong> ${fnData.territorialNotes}</p>
                                <p><strong>Partnerships:</strong> ${fnData.partnerships}</p>
                            </div>
                        `;
                    }

                    // Add group image if available
                    if (groupData.mapImage) {
                        popupContent += `<img src="${groupData.mapImage}" alt="Zone Group Map" style="max-width: 300px;" />`;
                    }

                    popupContent += '</div>';

                    marker.bindPopup(popupContent, {
                        maxWidth: 400,
                        maxHeight: 300,
                        autoPan: true,
                        autoPanPadding: [20, 20],
                        keepInView: true,
                        closeOnEscapeKey: true,
                        className: 'zone-popup-container'
                    });
                    marker.addTo(group);
                });

                group.addTo(map);
            });
        }

        // Marine operations data
        const marineOperationsData = [
            {name: "LNG Canada Kitimat", lat: 54.028571, lng: -128.691677, type: "LNG", category: "Energy", description: "Operational 14 million tonnes/year"},
            {name: "Prince Rupert Port", lat: 54.2883, lng: -130.3562, type: "Port", category: "Infrastructure", description: "North America's deepest natural harbor"},
            {name: "Kid Bay Farm", lat: 52.80108, lng: -128.40431, type: "Aquaculture", category: "Salmon", description: "Mowi Canada active site"},
            {name: "Goat Cove Farm", lat: 52.78726, lng: -128.4199, type: "Aquaculture", category: "Salmon", description: "Mowi Canada active site"}
        ];

        // Initialize marine operations
        function initMarineOperations() {
            marineOperationsData.forEach(operation => {
                const mainType = operation.type;

                if (!operationTypes[mainType]) {
                    operationTypes[mainType] = L.layerGroup();
                }

                const marker = L.marker([operation.lat, operation.lng]);

                const popupContent = `
                    <div style="min-width: 200px;">
                        <h4 style="margin: 0 0 8px 0;">${operation.name}</h4>
                        <p><strong>Type:</strong> ${operation.type}</p>
                        <p><strong>Category:</strong> ${operation.category}</p>
                        <p><strong>Description:</strong> ${operation.description}</p>
                        <p><strong>Coordinates:</strong> ${operation.lat.toFixed(4)}¬∞N, ${Math.abs(operation.lng).toFixed(4)}¬∞W</p>
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.addTo(operationTypes[mainType]);
            });

            // Add operation layers to map
            Object.values(operationTypes).forEach(layer => {
                layer.addTo(map);
            });
        }

        // Layer control event listeners
        function setupLayerControls() {
            // MCP Zone toggles - fix the ID matching
            Object.keys(zoneColors).forEach(groupKey => {
                const checkbox = document.getElementById(`zones-${groupKey}`);
                if (checkbox) {
                    console.log(`Setting up checkbox for zones-${groupKey}`);
                    checkbox.addEventListener('change', function() {
                        console.log(`Checkbox ${groupKey} changed to:`, this.checked);
                        if (this.checked) {
                            map.addLayer(mcpZoneGroups[groupKey]);
                        } else {
                            map.removeLayer(mcpZoneGroups[groupKey]);
                        }
                    });
                } else {
                    console.error(`Checkbox not found for zones-${groupKey}`);
                }
            });

            // Operation type toggles
            const operationCheckboxes = {
                'lng-facilities': 'LNG',
                'ports': 'Port',
                'aquaculture': 'Aquaculture'
            };

            Object.entries(operationCheckboxes).forEach(([checkboxId, operationType]) => {
                const checkbox = document.getElementById(checkboxId);
                if (checkbox) {
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            map.addLayer(operationTypes[operationType]);
                        } else {
                            map.removeLayer(operationTypes[operationType]);
                        }
                    });
                }
            });
        }

        // Initialize map
        document.addEventListener('DOMContentLoaded', function() {
            try {
                initMCPZones();
                initMarineOperations();
                setupLayerControls();
            } catch (error) {
                console.error('Map initialization error:', error);
            }
        });
    </script>
</body>
</html>